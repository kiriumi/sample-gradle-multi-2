# Gradleマルチプロジェクトのサンプル２

## 概要
* Gradleのマルチプロジェクトを利用した、構成管理を統制したプロジェクト

## 方針
* Gradleのマルチプロジェクトを利用し、設定や処理を共通化する
* 一括ですべてのプロジェクトをビルド・デプロイできるようにする
* 個々のサブプロジェクトをビルド・デプロイできるようにする
* SVNで個々のサブプロジェクトをチェックアウトし、開発ができる
  * masterプロジェクトも一緒にチェックアウトはしてもらう
* 最新の公開Jarを共有・参照して開発ができる
  * 個々のサブプロジェクトで公開Jarを作成し、Mavenリポジトリにアップロードできる
  * 常に最新の公開Jarを参照できるようにする

## 用語集
* アーカイブ：Jar, War, Earの総称
* 公開Jar：社内MavenリポジトリにアップロードするJar
* 公開Jar（Web）：社内Mavenリポジトリにアップロードする、Webリソースを含むJar
* 基盤Jar：Mevenセントラルリポジトリから取得するJar
* 業務アーカイブ：業務アプリケーションのアーカイブ
* ステージング環境：CT環境／ST環境／面など

## コードライン運用
* ステージングブランチを基にステージングタグを作成する
* ステージングタグをビルドしてアーカイブを作成し、その結果をにタグにコミットする
  * Jenkinsのビルドジョブで実施
* ビルド後のステージングタグから、開発者指定のステージング環境に沿ったリソースを集約し、デプロイする
  * Jenkinsのデプロイジョブで実施
  * リリース対象のステージングタグ、ステージング環境、リソースはジョブパラメータで指定

### UT
1. trunkからUTブランチを作成
1. UTが完了したらUTブランチにコミット

※コミットをトリガーに、Jenkinsで自動テストを行う<br>
※コミットをトリガーに、Jenkinsで公開Jar, 公開Jar（Web）は、社内Mavenリポジトリにアップロードする

### CT
1. UTブランチからステージングブランチを作成する
1. 改修したリソースは、UTブランチからステージングブランチにマージ
1. ステージングブランチを基に、ステージングタグを手動で作成
1. 開発者がステージングタグを指定し、Jenkinsがそのタグを基にビルドを実行し、結果をコミットする
1. 開発者がステージングタグ、ステージング環境、リソースを指定し、Jenkinsがデプロイ<br>

※ステージングブランチは、ステージング環境と紐づける<br>
※ブランチからチェックアウトし、タグとしてコミットする場合、新規リソースはコミットできない（既存リソースの改修ならOK）

### ST
1. 開発者がステージングタグ、ステージング環境、リソースを指定し、Jenkinsがデプロイ

### 本番
1. 開発者がステージングタグ、ステージング環境、リソースを指定し、Jenkinsがデプロイ

## プロジェクト構成
### サブプロジェクトの種類とリリース対象のリソース
* 公開Jar（Web）は、業務Webアプリケーションに含むので、サーバにデプロイはしない
* Webプロジェクトにシェルは不要

#### 基盤ソフトウェア
* ドメイン：公開Jar, シェル, 外部設定ファイル
* Web：外部設定ファイル
* バッチ：公開Jar, シェル, 外部設定ファイル

#### 業務共通
* ドメイン：公開Jar, シェル, 外部設定ファイル
* Web：外部設定ファイル
* バッチ：公開Jar, シェル, 外部設定ファイル

#### 業務アプリケーション
* Web：War, 外部設定ファイル
* バッチ：業務Jar, シェル, 外部設定ファイル

## アーカイブの作成単位
* 公開Jarはサブプロジェクト単位
* Warはサブプロジェクト単位
* 業務バッチJarはグループID.batch直下のパッケージ単位

## 社内Mavenリポジトリ
* 基盤Jarは、Mavenセントラルリポジトリから取得する
* UTの公開Jar, 公開Jar（Web）のみ、社内Mavenリポジトリに格納する
* CT以降は、公開Jar, 公開Jar（Web）は、社内Mavenリポジトリに格納しない

## アーカイブのバージョン運用
* 社内Mavenリポジトリにアップロードする、公開Jar, 公開Jar（Web）のみバージョン番号を付ける
  * {メジャー番号}.{マイナー番号}-SNAPTHOT
  * メジャー番号：機能追加・改修
  * マイナー番号：バグ改修
* 業務アーカイブにはバージョンを付けない
* CT以降は、公開Jar, 公開Jar（Web）もバージョンを付けない<br>
  ∵ 古いバージョンの業務アーカイブを削除する必要が出てくるため

## 外部設定ファイル
* 業務バッチアプリケーションは、すべて外部設定ファイルにする（切分けの判断をなくすため）
* 公開Jar, 公開Jar（Web）, Warは、環境情報のみ外部設定ファイルにする

## クラスパス
* 業務Jar, 公開Jarは同一のディレクトリにデプロイし、クラスパスに個々のJarを指定する
* 基盤Jarは↑とは異なるディレクトリにデプロイし、クラスパスに「*」で一括にJarを指定する

## Webリソースを含む公開Jar
* コーディング時は、warでサーバにデプロイできるようにする
* 公開Jar作成時は、META-INF/resourcesにWebリソースを含める

## 実行タスク
### 公開Jar, 公開Jar（Web）の社内Mavenリポジトリにアップロード
1. clean publish

### 個別デプロイ
#### Web
1. clean war
1. distZip
1. deploy
1. deployWeb

#### バッチ
1. clean jar
1. distZip
1. deploy

### 一括デプロイ
#### Web
1. clean jar
1. distZip
1. distZipAllBatch
1. deploy
1. deployWeb

#### バッチ
1. clean war
1. distZip
1. distZipAllWeb
1. deploy
1. deployWeb
